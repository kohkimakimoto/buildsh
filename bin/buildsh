#!/usr/bin/env bash

#/ Usage: buildsh [<options...>] -- [<commands...>]
#/
#/ Buildsh is docker powered shell that make it easy to run isolated
#/ environment for building, testing and deploying softwares.
#/
#/ The MIT License (MIT)
#/ Kohki Makimoto <kohki.makimoto@gmail.com>
#/
#/ Options:
#/     -e, --env <KEY=VALUE>      Set custom environment variables.
#/     -h, --help                 Show help.
#/     -d, --debug                Use debug mode.
#/     -u, --self-update          Update buildsh.
#/     --rcfile <FILE>            Load configuration from the FILE instead of .buildshrc
#/     --clean                    Remove cache.
#/
#/ Examples:
#/     buildsh
#/     buildsh -- ls -la
#/
#/ Configuration:
#/     Buildsh loads .buildshrc file if it is existed in your current directory.
#/
#/ Description:
#/     Run an arbitrary command in the isolated container.
#/     If you run a command without any options,
#/     buildsh boots the container with interactive shell (default bash).
#/
#/ See also:
#/     https://github.com/kohkimakimoto/buildsh
#/
set -e

# common functions
abort() {
  { if [ "$#" -eq 0 ]; then cat -
    else echo "${progname} error: $*"
    fi
  } >&2
  exit 1
}

print_help() {
    local filepath="$(abs_dirname "$0")/$progname"
    grep '^#/' <"$filepath" | cut -c4-
}

resolve_link() {
  $(type -p greadlink readlink | head -1) "$1"
}

abs_dirname() {
  local cwd="$(pwd)"
  local path="$1"

  while [ -n "$path" ]; do
    cd "${path%/*}"
    local name="${path##*/}"
    path="$(resolve_link "$name" || true)"
  done

  pwd
  cd "$cwd"
}

# variables
if [ -z "$BUILDSH_ROOT" ]; then
    BUILDSH_ROOT=$(abs_dirname "$(abs_dirname "$0")")
fi
if [ -z "$BUILDSH_DOCKER_IMAGE" ]; then
    BUILDSH_DOCKER_IMAGE="kohkimakimoto/buildsh:latest"
fi
if [ -z "$BUILDSH_DOCKER_OPTIONS" ]; then
    BUILDSH_DOCKER_OPTIONS="--rm -e TZ=Asia/Tokyo"
fi
if [ -z "$BUILDSH_ADDITIONAL_DOCKER_OPTIONS" ]; then
    BUILDSH_ADDITIONAL_DOCKER_OPTIONS=""
fi
if [ -z "$BUILDSH_ENV" ]; then
    BUILDSH_ENV=()
fi
if [ -z "$BUILDSH_RCFILE" ]; then
    BUILDSH_RCFILE="$PWD/.buildshrc"
fi
if [ -z "$BUILDSH_HOME" ]; then
    BUILDSH_HOME="$PWD"
fi
if [ -z "$BUILDSH_CONTAINER_HOME" ]; then
    BUILDSH_CONTAINER_HOME="/build"
fi
if [ -z "$BUILDSH_CONTAINER_WORKDIR" ]; then
    BUILDSH_CONTAINER_WORKDIR="/build"
fi
if [ -z "$BUILDSH_CONTAINER_BUILDSH_ROOT" ]; then
    BUILDSH_CONTAINER_BUILDSH_ROOT="/.buildsh"
fi
if [ -z "$BUILDSH_CMD" ]; then
    BUILDSH_CMD=""
fi
if [ -z "$BUILDSH_USE_CACHE" ]; then
    BUILDSH_USE_CACHE=""
fi

# internal variables
progname=$(basename $0)
buildsh_env=()
debug_mode=""

# actions
clean_cache() {
    if [ -n "$buildsh_cachedir" ]; then
        if [ -d "$buildsh_cachedir" ]; then
            rm -rf "$buildsh_cachedir"
        fi
        mkdir -p $buildsh_cachedir
    fi
}

self_update() {
    cd $BUILDSH_ROOT
    git pull origin master
}

# utility functions for .buildshrc
use_cache() {
    BUILDSH_USE_CACHE=1
}

docker_option() {
    BUILDSH_DOCKER_OPTIONS="$BUILDSH_DOCKER_OPTIONS $1"
}

envvar() {
    BUILDSH_ENV+=( "$1" )
}

home_in_container() {
    BUILDSH_CONTAINER_HOME="$1"
    BUILDSH_CONTAINER_WORKDIR="$BUILDSH_CONTAINER_HOME"
}

docker_image() {
    BUILDSH_DOCKER_IMAGE="$1"
}

disable_buildsh_in_container() {
    BUILDSH_CONTAINER_BUILDSH_ROOT=""
}

# update internal variables
buildsh_cachedir="$BUILDSH_HOME/.buildsh/cache"

# parse arguments and options.
declare -a params=()
for opt in "$@"
do
    case "$opt" in
        '-h')
            print_help
            exit 0
            ;;
        '--help')
            print_help
            exit 0
            ;;
        '--clean')
            clean_cache
            exit 0
            ;;
        '-u'|'--self-update')
            self_update
            exit 0
            ;;
        '-d'|'--debug')
            debug_mode=1
            shift 1
            ;;
        '-e'|'--env' )
            if [[ -z "${2:-}" ]] || [[ "${2:-}" =~ ^-+ ]]; then
                abort "option '$1' requires an argument."
            fi
            buildsh_env+=( "$2" )
            shift 2
            ;;
        '-e='*)
            optval="${opt:3}"
            if [ -z "$optval" ]; then
                abort "option '$1' requires an argument."
            fi
            buildsh_env+=( "$optval" )
            shift 1
            ;;
        '--env='*)
            optval="${opt:6}"
            if [ -z "$optval" ]; then
                abort "option '$1' requires an argument."
            fi
            buildsh_env+=( "$optval" )
            shift 1
            ;;
        '--rcfile' )
            if [[ -z "${2:-}" ]] || [[ "${2:-}" =~ ^-+ ]]; then
                abort "option '$1' requires an argument."
            fi
            BUILDSH_RCFILE="$2"
            shift 2
            ;;
        '--rcfile='*)
            optval="${opt:9}"
            if [ -z "$optval" ]; then
                abort "option '$1' requires an argument."
            fi
            BUILDSH_RCFILE="$optval"
            shift 1
            ;;
        '--'|'-' )
            shift 1
            params+=( "$@" )
            break
            ;;
        -*)
            abort "illegal option -- '$(echo $1 | sed 's/^-*//')'"
            ;;
        *)
            if [[ ! -z "${1:-}" ]] && [[ ! "${1:-}" =~ ^-+ ]]; then
                params+=( "$1" )
                shift 1
            fi
            ;;
    esac
done

if [ -n "$debug_mode" ]; then
  export PS4='+ [${BASH_SOURCE##*/}:${LINENO}] '
  set -x
fi

# load rcfile
if [ -f "$BUILDSH_RCFILE" ]; then
    . $BUILDSH_RCFILE
fi

if [  ${#params[@]} -eq 0 ]; then
    if [ -z "$BUILDSH_CMD" ]; then
        BUILDSH_CMD="/bin/bash"
        BUILDSH_DOCKER_OPTIONS="$BUILDSH_DOCKER_OPTIONS -i -t"
    fi
else
    BUILDSH_CMD="${params[@]}"
fi

buildsh_env_options=""
if [ "${#BUILDSH_ENV[@]}" -gt 0 ]; then
    for v in "${BUILDSH_ENV[@]}"
    do
        buildsh_env_options="$buildsh_env_options -e $v"
    done
fi

if [ "${#buildsh_env[@]}" -gt 0 ]; then
    for v in "${buildsh_env[@]}"
    do
        buildsh_env_options="$buildsh_env_options -e $v"
    done
fi

buildsh_env_for_cache=""
if [ -n "$BUILDSH_USE_CACHE" ]; then
    mkdir -p $buildsh_cachedir
    buildsh_env_for_cache="-e BUILDSH_USE_CACHE=1 -e BUILDSH_CACHEDIR=$BUILDSH_CONTAINER_HOME/.buildsh/cache"
fi

buildsh_root_mount_option=""
if [ -n "$BUILDSH_CONTAINER_BUILDSH_ROOT" ]; then
    buildsh_root_mount_option="-v $BUILDSH_ROOT:$BUILDSH_CONTAINER_BUILDSH_ROOT:ro"
fi

docker run \
  -w $BUILDSH_CONTAINER_WORKDIR \
  -v $BUILDSH_HOME:$BUILDSH_CONTAINER_HOME \
  $BUILDSH_DOCKER_OPTIONS \
  $BUILDSH_ADDITIONAL_DOCKER_OPTIONS \
  $buildsh_env_for_cache \
  $buildsh_env_options \
  $buildsh_root_mount_option \
  -e "BUILDSH=1" \
  -e "BUILDSH_USER=$(id -u):$(id -g)" \
  $BUILDSH_DOCKER_IMAGE \
  $BUILDSH_CMD
